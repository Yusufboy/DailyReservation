name: VuSpace Auto Reserve (Next Week)

on:
  schedule:
    # TR: Pazartesi–Cuma 00:01
    # UTC: Pazar–Perşembe 21:01 (00:01 TR = 21:01 UTC önceki gün)
    - cron: "1 21 * * 0-4"
  workflow_dispatch:

jobs:
  reserve:
    runs-on: ubuntu-latest
    steps:
      - name: Reserve next week's same weekday (skip public holidays)
        env:
          TARGET_URL: ${{ secrets.TARGET_URL }}
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
          AREA_ID: ${{ secrets.AREA_ID }}
          ORGANIZER: ${{ secrets.ORGANIZER }}
          EXTRA_SKIP_DATES: ${{ secrets.EXTRA_SKIP_DATES }}
        run: |
          set -euo pipefail

          TODAY_TR=$(TZ=Europe/Istanbul date +%F)
          TARGET_DATE=$(TZ=Europe/Istanbul date -d "$TODAY_TR + 7 days" +%F)
          YEAR="${TARGET_DATE:0:4}"

          echo "Today(TR):  $TODAY_TR"
          echo "Target day: $TARGET_DATE"

          # Opsiyonel ekstra skip (şirket tatili vb.)
          if [ -n "${EXTRA_SKIP_DATES:-}" ]; then
            if echo ",$EXTRA_SKIP_DATES," | grep -q ",$TARGET_DATE,"; then
              echo "Target date is in EXTRA_SKIP_DATES => skipping."
              exit 0
            fi
          fi

          # TR resmi tatil kontrolü (Nager.Date) - jq ile
          HOLIDAYS_JSON="$(curl -fsSL "https://date.nager.at/api/v3/PublicHolidays/$YEAR/TR" || true)"
          if [ -n "$HOLIDAYS_JSON" ]; then
            IS_HOLIDAY="$(echo "$HOLIDAYS_JSON" | jq -r --arg d "$TARGET_DATE" 'map(select(.date == $d)) | length')"
            if [ "$IS_HOLIDAY" != "0" ]; then
              echo "Target date is a TR public holiday => skipping."
              exit 0
            fi
          else
            echo "Warning: couldn't fetch holidays; continuing without holiday check."
          fi

          START="${TARGET_DATE}T08:00:00"
          END="${TARGET_DATE}T17:00:00"

          echo "Sending reservation for: $TARGET_DATE"
          echo "areaId: $AREA_ID organizer: $ORGANIZER"

          # multipart/form-data'yi curl -F otomatik doğru şekilde kurar (boundary dahil).
          curl -sS -i -X POST "$TARGET_URL" \
            -H "Accept: application/json, text/plain, */*" \
            -H "Authorization: Bearer $BEARER_TOKEN" \
            -H "Origin: https://amadeus.avuity.com" \
            -H "Referer: https://amadeus.avuity.com/VuSpace2/" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36" \
            -F "areaId=$AREA_ID" \
            -F "dates[0][start]=$START" \
            -F "dates[0][end]=$END" \
            -F "organizer=$ORGANIZER"
